/*
THIS IS A GENERATED/BUNDLED FILE BY ROLLUP
if you want to view the source visit the plugins github repository
*/

'use strict';

var obsidian = require('obsidian');

// Remove Widgets in CodeMirror Editor
const clearWidges = (cm) => {
    var lastLine = cm.lastLine();
    for (let i = 0; i <= lastLine; i++) {
        // Get the current Line
        const line = cm.lineInfo(i);
        // Clear the image widgets if exists
        if (line.widgets) {
            for (const wid of line.widgets) {
                if (wid.className === 'oz-image-widget') {
                    wid.clear();
                }
            }
        }
    }
};
// Http, Https Link Check
const filename_is_a_link = (filename) => filename.startsWith('http');
// Image Name and Alt Text
const getFileNameAndAltText = (linkType, match) => {
    /*
       linkType 1: [[myimage.jpg|#x-small]]
       linkType2: ![#x-small](myimage.jpg)
       returns { fileName: '', altText: '' }
    */
    var file_name_regex;
    var alt_regex;
    if (linkType == 1) {
        file_name_regex = /(?<=\[\[).*(jpe?g|png|gif)/;
        alt_regex = /(?<=\|).*(?=]])/;
    }
    else if (linkType == 2) {
        file_name_regex = /(?<=\().*(jpe?g|png|gif)/;
        alt_regex = /(?<=\[)(^$|.*)(?=\])/;
    }
    var file_match = match[0].match(file_name_regex);
    var alt_match = match[0].match(alt_regex);
    return { fileName: file_match ? file_match[0] : '',
        altText: alt_match ? alt_match[0] : '' };
};
// Getting Active Markdown File
const getActiveNoteFile = (workspace) => {
    return workspace.activeLeaf.view.file;
};
const getPathOfVault = (vault) => {
    var path = vault.adapter.basePath;
    if (path.startsWith('/'))
        return 'app://local' + path;
    return 'app://local/' + path;
};
// Temporary Solution until getResourcePath improved 
const getPathOfImage = (vault, image) => {
    // vault.getResourcePath(image) 
    return getPathOfVault(vault) + '/' + image.path;
};
const getFileCmBelongsTo = (cm, workspace) => {
    var _a;
    let leafs = workspace.getLeavesOfType("markdown");
    for (let i = 0; i < leafs.length; i++) {
        if (((_a = leafs[i].view.sourceMode) === null || _a === void 0 ? void 0 : _a.cmEditor) == cm) {
            return leafs[i].view.file;
        }
    }
    return null;
};

class OzanImagePlugin extends obsidian.Plugin {
    constructor() {
        super(...arguments);
        // Line Edit Changes
        this.codemirrorLineChanges = (cm, changes) => {
            changes.some((change) => {
                this.check_line(cm, change.to.line);
            });
        };
        // Check Single Line
        this.check_line = (cm, line_number, targetFile) => {
            // Regex for [[ ]] format
            const image_line_regex_1 = /!\[\[.*(jpe?g|png|gif).*\]\]/;
            // Regex for ![ ]( ) format
            const image_line_regex_2 = /!\[(^$|.*)\]\(.*(jpe?g|png|gif)\)/;
            // Get the Line edited
            const line = cm.lineInfo(line_number);
            if (line === null)
                return;
            // Current Line Comparison with Regex
            const match_1 = line.text.match(image_line_regex_1);
            const match_2 = line.text.match(image_line_regex_2);
            // Clear the widget if link was removed
            var line_image_widget = line.widgets ? line.widgets.filter((wid) => wid.className === 'oz-image-widget') : false;
            if (line_image_widget && (!match_1 || !match_2))
                line_image_widget[0].clear();
            // If any of regex matches, it will add image widget
            if (match_1 || match_2) {
                // Clear the image widgets if exists
                if (line.widgets) {
                    for (const wid of line.widgets) {
                        if (wid.className === 'oz-image-widget') {
                            wid.clear();
                        }
                    }
                }
                // Get the file name and alt text depending on format
                var filename = '';
                var alt = '';
                if (match_1) {
                    // Regex for [[myimage.jpg|#x-small]] format
                    filename = getFileNameAndAltText(1, match_1).fileName;
                    alt = getFileNameAndAltText(1, match_1).altText;
                }
                else if (match_2) {
                    // Regex for ![#x-small](myimage.jpg) format
                    filename = getFileNameAndAltText(2, match_2).fileName;
                    alt = getFileNameAndAltText(2, match_2).altText;
                }
                // Create Image
                const img = document.createElement('img');
                // Prepare the src for the Image
                if (filename_is_a_link(filename)) {
                    img.src = filename;
                }
                else {
                    // Source Path
                    var sourcePath = '';
                    if (targetFile != null) {
                        sourcePath = targetFile.path;
                    }
                    else {
                        let activeNoteFile = getActiveNoteFile(this.app.workspace);
                        sourcePath = activeNoteFile ? activeNoteFile.path : '';
                    }
                    var image = this.app.metadataCache.getFirstLinkpathDest(decodeURIComponent(filename), sourcePath);
                    if (image != null)
                        img.src = getPathOfImage(this.app.vault, image);
                }
                // Image Properties
                img.alt = alt;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                // Add Image widget under the Image Markdown
                cm.addLineWidget(line_number, img, { className: 'oz-image-widget' });
            }
        };
        // Check All Lines Function
        this.check_lines = (cm) => {
            // Last Used Line Number in Code Mirror
            var lastLine = cm.lastLine();
            var file = getFileCmBelongsTo(cm, this.app.workspace);
            for (let i = 0; i <= lastLine; i++) {
                this.check_line(cm, i, file);
            }
        };
        // Handle file after file-open event
        this.handleFileOpen = (targetFile) => {
            // If any file fired, iterated CodeMirrors
            this.app.workspace.iterateCodeMirrors((cm) => {
                this.check_lines(cm);
            });
        };
    }
    onload() {
        // Each file open will fire
        this.registerEvent(this.app.workspace.on("file-open", this.handleFileOpen));
        // Register event for each change
        this.registerCodeMirror((cm) => {
            cm.on("changes", this.codemirrorLineChanges);
        });
    }
    onunload() {
        this.app.workspace.iterateCodeMirrors((cm) => {
            this.app.workspace.off("file-open", this.handleFileOpen);
            cm.off("changes", this.codemirrorLineChanges);
            clearWidges(cm);
        });
        new obsidian.Notice('Image in Editor Plugin is unloaded');
    }
}

module.exports = OzanImagePlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXMiOlsic3JjL3V0aWxzLnRzIiwic3JjL21haW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV29ya3NwYWNlLCBNYXJrZG93blZpZXcsIFZhdWx0LCBURmlsZSwgbm9ybWFsaXplUGF0aCB9IGZyb20gJ29ic2lkaWFuJztcblxuLy8gUmVtb3ZlIFdpZGdldHMgaW4gQ29kZU1pcnJvciBFZGl0b3JcbmNvbnN0IGNsZWFyV2lkZ2VzID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvcikgPT4ge1xuICAgIHZhciBsYXN0TGluZSA9IGNtLmxhc3RMaW5lKCk7XG5cbiAgICBmb3IobGV0IGk9MDsgaSA8PSBsYXN0TGluZTsgaSsrKXtcbiAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50IExpbmVcbiAgICAgICAgY29uc3QgbGluZSA9IGNtLmxpbmVJbmZvKGkpO1xuICAgICAgICAvLyBDbGVhciB0aGUgaW1hZ2Ugd2lkZ2V0cyBpZiBleGlzdHNcbiAgICAgICAgaWYgKGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICBmb3IoY29uc3Qgd2lkIG9mIGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgaWYgKHdpZC5jbGFzc05hbWUgPT09ICdvei1pbWFnZS13aWRnZXQnKXtcbiAgICAgICAgICAgICAgICAgICAgd2lkLmNsZWFyKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vIEh0dHAsIEh0dHBzIExpbmsgQ2hlY2tcbmNvbnN0IGZpbGVuYW1lX2lzX2FfbGluayA9IChmaWxlbmFtZTogc3RyaW5nKSA9PiBmaWxlbmFtZS5zdGFydHNXaXRoKCdodHRwJyk7XG5cbiAvLyBJbWFnZSBOYW1lIGFuZCBBbHQgVGV4dFxuY29uc3QgZ2V0RmlsZU5hbWVBbmRBbHRUZXh0ID0obGlua1R5cGU6IG51bWJlciwgbWF0Y2g6IGFueSkgPT4ge1xuICAgIC8qIFxuICAgICAgIGxpbmtUeXBlIDE6IFtbbXlpbWFnZS5qcGd8I3gtc21hbGxdXVxuICAgICAgIGxpbmtUeXBlMjogIVsjeC1zbWFsbF0obXlpbWFnZS5qcGcpIFxuICAgICAgIHJldHVybnMgeyBmaWxlTmFtZTogJycsIGFsdFRleHQ6ICcnIH0gICBcbiAgICAqL1xuXG4gICAgdmFyIGZpbGVfbmFtZV9yZWdleDtcbiAgICB2YXIgYWx0X3JlZ2V4O1xuXG4gICAgaWYobGlua1R5cGUgPT0gMSl7XG4gICAgICAgIGZpbGVfbmFtZV9yZWdleCA9IC8oPzw9XFxbXFxbKS4qKGpwZT9nfHBuZ3xnaWYpLztcbiAgICAgICAgYWx0X3JlZ2V4ID0gLyg/PD1cXHwpLiooPz1dXSkvO1xuICAgIH0gZWxzZSBpZihsaW5rVHlwZSA9PSAyKXtcbiAgICAgICAgZmlsZV9uYW1lX3JlZ2V4ID0gLyg/PD1cXCgpLiooanBlP2d8cG5nfGdpZikvO1xuICAgICAgICBhbHRfcmVnZXggPSAvKD88PVxcWykoXiR8LiopKD89XFxdKS87XG4gICAgfVxuXG4gICAgdmFyIGZpbGVfbWF0Y2ggPSBtYXRjaFswXS5tYXRjaChmaWxlX25hbWVfcmVnZXgpO1xuICAgIHZhciBhbHRfbWF0Y2ggPSBtYXRjaFswXS5tYXRjaChhbHRfcmVnZXgpO1xuXG4gICAgcmV0dXJuIHsgZmlsZU5hbWU6IGZpbGVfbWF0Y2ggPyBmaWxlX21hdGNoWzBdIDogJycsIFxuICAgICAgICAgICAgYWx0VGV4dDogYWx0X21hdGNoID8gYWx0X21hdGNoWzBdIDogJycgfVxuXG59ICAgIFxuXG4vLyBHZXR0aW5nIEFjdGl2ZSBNYXJrZG93biBGaWxlXG5jb25zdCBnZXRBY3RpdmVOb3RlRmlsZSA9ICh3b3Jrc3BhY2U6IFdvcmtzcGFjZSkgPT4ge1xuICAgIHJldHVybiAod29ya3NwYWNlLmFjdGl2ZUxlYWYudmlldyBhcyBNYXJrZG93blZpZXcpLmZpbGU7XG59XG5cbi8vIEdldCBBY3RpdmUgRWRpdG9yXG5jb25zdCBnZXRDbUVkaXRvciA9ICh3b3Jrc3BhY2U6IFdvcmtzcGFjZSk6IENvZGVNaXJyb3IuRWRpdG9yID0+IHtcbiAgICByZXR1cm4gd29ya3NwYWNlLmdldEFjdGl2ZVZpZXdPZlR5cGUoTWFya2Rvd25WaWV3KT8uc291cmNlTW9kZT8uY21FZGl0b3Jcbn1cblxuY29uc3QgZ2V0UGF0aE9mVmF1bHQgPSAodmF1bHQ6IFZhdWx0KTogc3RyaW5nID0+IHtcbiAgICB2YXIgcGF0aCA9IHZhdWx0LmFkYXB0ZXIuYmFzZVBhdGg7XG4gICAgaWYocGF0aC5zdGFydHNXaXRoKCcvJykpIHJldHVybiAnYXBwOi8vbG9jYWwnICsgcGF0aFxuICAgIHJldHVybiAnYXBwOi8vbG9jYWwvJyArIHBhdGhcbn1cblxuLy8gVGVtcG9yYXJ5IFNvbHV0aW9uIHVudGlsIGdldFJlc291cmNlUGF0aCBpbXByb3ZlZCBcbmNvbnN0IGdldFBhdGhPZkltYWdlID0gKHZhdWx0OiBWYXVsdCwgaW1hZ2U6IFRGaWxlKSA9PiB7XG4gICAgLy8gdmF1bHQuZ2V0UmVzb3VyY2VQYXRoKGltYWdlKSBcbiAgICByZXR1cm4gZ2V0UGF0aE9mVmF1bHQodmF1bHQpICsgJy8nICsgaW1hZ2UucGF0aFxufVxuXG5jb25zdCBnZXRGaWxlQ21CZWxvbmdzVG8gPSAoY206IENvZGVNaXJyb3IuRWRpdG9yLCB3b3Jrc3BhY2U6IFdvcmtzcGFjZSkgPT4ge1xuICAgIGxldCBsZWFmcyA9IHdvcmtzcGFjZS5nZXRMZWF2ZXNPZlR5cGUoXCJtYXJrZG93blwiKTtcbiAgICBmb3IobGV0IGk9MDsgaSA8IGxlYWZzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYobGVhZnNbaV0udmlldy5zb3VyY2VNb2RlPy5jbUVkaXRvciA9PSBjbSl7XG4gICAgICAgICAgICByZXR1cm4gbGVhZnNbaV0udmlldy5maWxlXG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59IFxuXG5leHBvcnQgeyBjbGVhcldpZGdlcywgZmlsZW5hbWVfaXNfYV9saW5rLCBnZXRGaWxlTmFtZUFuZEFsdFRleHQsXG4gICAgZ2V0QWN0aXZlTm90ZUZpbGUsIGdldENtRWRpdG9yLCBnZXRQYXRoT2ZJbWFnZSwgZ2V0RmlsZUNtQmVsb25nc1RvIH07IiwiaW1wb3J0IHsgUGx1Z2luLCBOb3RpY2UsIFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgY2xlYXJXaWRnZXMsIGZpbGVuYW1lX2lzX2FfbGluaywgZ2V0RmlsZU5hbWVBbmRBbHRUZXh0LFxuICAgICAgICBnZXRBY3RpdmVOb3RlRmlsZSwgZ2V0UGF0aE9mSW1hZ2UsIGdldEZpbGVDbUJlbG9uZ3NUbyB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPemFuSW1hZ2VQbHVnaW4gZXh0ZW5kcyBQbHVnaW57XG5cbiAgICBvbmxvYWQoKXtcbiAgICAgICAgLy8gRWFjaCBmaWxlIG9wZW4gd2lsbCBmaXJlXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudChcbiAgICAgICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5vbihcImZpbGUtb3BlblwiLCB0aGlzLmhhbmRsZUZpbGVPcGVuKVxuICAgICAgICApXG4gICAgICAgIC8vIFJlZ2lzdGVyIGV2ZW50IGZvciBlYWNoIGNoYW5nZVxuICAgICAgICB0aGlzLnJlZ2lzdGVyQ29kZU1pcnJvciggKGNtOiBDb2RlTWlycm9yLkVkaXRvcikgPT4ge1xuICAgICAgICAgICAgY20ub24oXCJjaGFuZ2VzXCIsIHRoaXMuY29kZW1pcnJvckxpbmVDaGFuZ2VzKTtcbiAgICAgICAgfSkgICAgICAgIFxuICAgIH1cblxuICAgIG9udW5sb2FkKCl7XG4gICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5pdGVyYXRlQ29kZU1pcnJvcnMoIChjbSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHAud29ya3NwYWNlLm9mZihcImZpbGUtb3BlblwiLCB0aGlzLmhhbmRsZUZpbGVPcGVuKTtcbiAgICAgICAgICAgIGNtLm9mZihcImNoYW5nZXNcIiwgdGhpcy5jb2RlbWlycm9yTGluZUNoYW5nZXMpO1xuICAgICAgICAgICAgY2xlYXJXaWRnZXMoY20pO1xuICAgICAgICB9KTtcbiAgICAgICAgbmV3IE5vdGljZSgnSW1hZ2UgaW4gRWRpdG9yIFBsdWdpbiBpcyB1bmxvYWRlZCcpO1xuICAgIH1cblxuICAgIC8vIExpbmUgRWRpdCBDaGFuZ2VzXG4gICAgY29kZW1pcnJvckxpbmVDaGFuZ2VzID0gKGNtOiBhbnksIGNoYW5nZXM6IGFueSkgPT4ge1xuICAgICAgICBjaGFuZ2VzLnNvbWUoIChjaGFuZ2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGVja19saW5lKGNtLCBjaGFuZ2UudG8ubGluZSk7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgU2luZ2xlIExpbmVcbiAgICBjaGVja19saW5lOiBhbnkgPSAoY206IENvZGVNaXJyb3IuRWRpdG9yLCBsaW5lX251bWJlcjogbnVtYmVyLCB0YXJnZXRGaWxlPzpURmlsZSkgPT4ge1xuXG4gICAgICAgIC8vIFJlZ2V4IGZvciBbWyBdXSBmb3JtYXRcbiAgICAgICAgY29uc3QgaW1hZ2VfbGluZV9yZWdleF8xID0gLyFcXFtcXFsuKihqcGU/Z3xwbmd8Z2lmKS4qXFxdXFxdL1xuICAgICAgICAvLyBSZWdleCBmb3IgIVsgXSggKSBmb3JtYXRcbiAgICAgICAgY29uc3QgaW1hZ2VfbGluZV9yZWdleF8yID0gLyFcXFsoXiR8LiopXFxdXFwoLiooanBlP2d8cG5nfGdpZilcXCkvXG4gICAgICAgIC8vIEdldCB0aGUgTGluZSBlZGl0ZWRcbiAgICAgICAgY29uc3QgbGluZSA9IGNtLmxpbmVJbmZvKGxpbmVfbnVtYmVyKTtcbiAgICAgICAgXG4gICAgICAgIGlmKGxpbmUgPT09IG51bGwpIHJldHVybjtcblxuICAgICAgICAvLyBDdXJyZW50IExpbmUgQ29tcGFyaXNvbiB3aXRoIFJlZ2V4XG4gICAgICAgIGNvbnN0IG1hdGNoXzEgPSBsaW5lLnRleHQubWF0Y2goaW1hZ2VfbGluZV9yZWdleF8xKTtcbiAgICAgICAgY29uc3QgbWF0Y2hfMiA9IGxpbmUudGV4dC5tYXRjaChpbWFnZV9saW5lX3JlZ2V4XzIpO1xuXG4gICAgICAgIC8vIENsZWFyIHRoZSB3aWRnZXQgaWYgbGluayB3YXMgcmVtb3ZlZFxuICAgICAgICB2YXIgbGluZV9pbWFnZV93aWRnZXQgPSBsaW5lLndpZGdldHMgPyBsaW5lLndpZGdldHMuZmlsdGVyKCh3aWQ6IHsgY2xhc3NOYW1lOiBzdHJpbmc7IH0pID0+IHdpZC5jbGFzc05hbWUgPT09ICdvei1pbWFnZS13aWRnZXQnKSA6IGZhbHNlO1xuICAgICAgICBpZihsaW5lX2ltYWdlX3dpZGdldCAmJiAoIW1hdGNoXzEgfHwgIW1hdGNoXzIpKSBsaW5lX2ltYWdlX3dpZGdldFswXS5jbGVhcigpO1xuXG4gICAgICAgIC8vIElmIGFueSBvZiByZWdleCBtYXRjaGVzLCBpdCB3aWxsIGFkZCBpbWFnZSB3aWRnZXRcbiAgICAgICAgaWYobWF0Y2hfMSB8fCBtYXRjaF8yKXtcbiAgICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIENsZWFyIHRoZSBpbWFnZSB3aWRnZXRzIGlmIGV4aXN0c1xuICAgICAgICAgICAgaWYgKGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgZm9yKGNvbnN0IHdpZCBvZiBsaW5lLndpZGdldHMpe1xuICAgICAgICAgICAgICAgICAgICBpZiAod2lkLmNsYXNzTmFtZSA9PT0gJ296LWltYWdlLXdpZGdldCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgd2lkLmNsZWFyKClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gR2V0IHRoZSBmaWxlIG5hbWUgYW5kIGFsdCB0ZXh0IGRlcGVuZGluZyBvbiBmb3JtYXRcbiAgICAgICAgICAgIHZhciBmaWxlbmFtZSA9ICcnO1xuICAgICAgICAgICAgdmFyIGFsdCA9ICcnO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZihtYXRjaF8xKXtcbiAgICAgICAgICAgICAgICAvLyBSZWdleCBmb3IgW1tteWltYWdlLmpwZ3wjeC1zbWFsbF1dIGZvcm1hdFxuICAgICAgICAgICAgICAgIGZpbGVuYW1lID0gZ2V0RmlsZU5hbWVBbmRBbHRUZXh0KDEsIG1hdGNoXzEpLmZpbGVOYW1lXG4gICAgICAgICAgICAgICAgYWx0ID0gZ2V0RmlsZU5hbWVBbmRBbHRUZXh0KDEsIG1hdGNoXzEpLmFsdFRleHRcbiAgICAgICAgICAgIH0gZWxzZSBpZihtYXRjaF8yKXtcbiAgICAgICAgICAgICAgICAvLyBSZWdleCBmb3IgIVsjeC1zbWFsbF0obXlpbWFnZS5qcGcpIGZvcm1hdFxuICAgICAgICAgICAgICAgIGZpbGVuYW1lID0gZ2V0RmlsZU5hbWVBbmRBbHRUZXh0KDIsIG1hdGNoXzIpLmZpbGVOYW1lXG4gICAgICAgICAgICAgICAgYWx0ID0gZ2V0RmlsZU5hbWVBbmRBbHRUZXh0KDIsIG1hdGNoXzIpLmFsdFRleHRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ3JlYXRlIEltYWdlXG4gICAgICAgICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcblxuICAgICAgICAgICAgLy8gUHJlcGFyZSB0aGUgc3JjIGZvciB0aGUgSW1hZ2VcbiAgICAgICAgICAgIGlmKGZpbGVuYW1lX2lzX2FfbGluayhmaWxlbmFtZSkpe1xuICAgICAgICAgICAgICAgIGltZy5zcmMgPSBmaWxlbmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU291cmNlIFBhdGhcbiAgICAgICAgICAgICAgICB2YXIgc291cmNlUGF0aCA9ICcnO1xuICAgICAgICAgICAgICAgIGlmKHRhcmdldEZpbGUgIT0gbnVsbCl7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGggPSB0YXJnZXRGaWxlLnBhdGg7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhY3RpdmVOb3RlRmlsZSA9IGdldEFjdGl2ZU5vdGVGaWxlKHRoaXMuYXBwLndvcmtzcGFjZSk7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGggPSBhY3RpdmVOb3RlRmlsZSA/IGFjdGl2ZU5vdGVGaWxlLnBhdGggOiAnJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGltYWdlID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaXJzdExpbmtwYXRoRGVzdChkZWNvZGVVUklDb21wb25lbnQoZmlsZW5hbWUpLCBzb3VyY2VQYXRoKTtcbiAgICAgICAgICAgICAgICBpZihpbWFnZSAhPSBudWxsKSBpbWcuc3JjID0gZ2V0UGF0aE9mSW1hZ2UodGhpcy5hcHAudmF1bHQsIGltYWdlKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBJbWFnZSBQcm9wZXJ0aWVzXG4gICAgICAgICAgICBpbWcuYWx0ID0gYWx0O1xuICAgICAgICAgICAgaW1nLnN0eWxlLm1heFdpZHRoID0gJzEwMCUnO1xuICAgICAgICAgICAgaW1nLnN0eWxlLmhlaWdodCA9ICdhdXRvJztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQWRkIEltYWdlIHdpZGdldCB1bmRlciB0aGUgSW1hZ2UgTWFya2Rvd25cbiAgICAgICAgICAgIGNtLmFkZExpbmVXaWRnZXQobGluZV9udW1iZXIsIGltZywge2NsYXNzTmFtZTogJ296LWltYWdlLXdpZGdldCd9KTsgICAgICAgICAgICBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIEFsbCBMaW5lcyBGdW5jdGlvblxuICAgIGNoZWNrX2xpbmVzOiBhbnkgPSAoY206IENvZGVNaXJyb3IuRWRpdG9yKSA9PiB7XG4gICAgICAgIC8vIExhc3QgVXNlZCBMaW5lIE51bWJlciBpbiBDb2RlIE1pcnJvclxuICAgICAgICB2YXIgbGFzdExpbmUgPSBjbS5sYXN0TGluZSgpO1xuICAgICAgICB2YXIgZmlsZSA9IGdldEZpbGVDbUJlbG9uZ3NUbyhjbSwgdGhpcy5hcHAud29ya3NwYWNlKTtcbiAgICAgICAgZm9yKGxldCBpPTA7IGkgPD0gbGFzdExpbmU7IGkrKyl7XG4gICAgICAgICAgICB0aGlzLmNoZWNrX2xpbmUoY20sIGksIGZpbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGZpbGUgYWZ0ZXIgZmlsZS1vcGVuIGV2ZW50XG4gICAgaGFuZGxlRmlsZU9wZW4gPSAodGFyZ2V0RmlsZTogVEZpbGUpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gSWYgYW55IGZpbGUgZmlyZWQsIGl0ZXJhdGVkIENvZGVNaXJyb3JzXG4gICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5pdGVyYXRlQ29kZU1pcnJvcnMoIChjbSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGVja19saW5lcyhjbSk7XG4gICAgICAgIH0pXG4gICAgfVxufSJdLCJuYW1lcyI6WyJQbHVnaW4iLCJOb3RpY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUVBO0FBQ0EsTUFBTSxXQUFXLEdBQUcsQ0FBQyxFQUFxQjtJQUN0QyxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7SUFFN0IsS0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBQzs7UUFFNUIsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7UUFFNUIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFDO1lBQ2IsS0FBSSxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFDO2dCQUMxQixJQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssaUJBQWlCLEVBQUM7b0JBQ3BDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtpQkFDZDthQUNKO1NBQ0o7S0FDSjtBQUNMLENBQUMsQ0FBQTtBQUVEO0FBQ0EsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLFFBQWdCLEtBQUssUUFBUSxDQUFD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
