/*
THIS IS A GENERATED/BUNDLED FILE BY ROLLUP
if you want to view the source visit the plugins github repository
*/

'use strict';

var obsidian = require('obsidian');

// Remove Widgets in CodeMirror Editor
const clearWidges = (cm) => {
    var lastLine = cm.lastLine();
    for (let i = 0; i <= lastLine; i++) {
        // Get the current Line
        const line = cm.lineInfo(i);
        // Clear the image widgets if exists
        if (line.widgets) {
            for (const wid of line.widgets) {
                if (wid.className === 'oz-image-widget') {
                    wid.clear();
                }
            }
        }
    }
};
// Http, Https Link Check
const filename_is_a_link = (filename) => {
    const url_regex = /^[a-z][a-z0-9+\-.]+:/i;
    return filename.match(url_regex) != null;
};
// Image Name and Alt Text
const getFileNameAndAltText = (linkType, match) => {
    /*
       linkType 1: [[myimage.jpg|#x-small]]
       linkType2: ![#x-small](myimage.jpg)
       returns { fileName: '', altText: '' }
    */
    var file_name_regex;
    var alt_regex;
    if (linkType == 1) {
        file_name_regex = /(?<=\[\[).*(jpe?g|png|gif|svg)/;
        alt_regex = /(?<=\|).*(?=]])/;
    }
    else if (linkType == 2) {
        file_name_regex = /(?<=\().*(jpe?g|png|gif|svg)/;
        alt_regex = /(?<=\[)(^$|.*)(?=\])/;
    }
    var file_match = match[0].match(file_name_regex);
    var alt_match = match[0].match(alt_regex);
    return { fileName: file_match ? file_match[0] : '',
        altText: alt_match ? alt_match[0] : '' };
};
// Getting Active Markdown File
const getActiveNoteFile = (workspace) => {
    return workspace.getActiveFile();
};
const getPathOfVault = (vault) => {
    var path = vault.adapter.basePath;
    if (path.startsWith('/'))
        return 'app://local' + path;
    return 'app://local/' + path;
};
// Temporary Solution until getResourcePath improved 
const getPathOfImage = (vault, image) => {
    // vault.getResourcePath(image) 
    return getPathOfVault(vault) + '/' + image.path;
};
const getFileCmBelongsTo = (cm, workspace) => {
    var _a;
    let leafs = workspace.getLeavesOfType("markdown");
    for (let i = 0; i < leafs.length; i++) {
        if (((_a = leafs[i].view.sourceMode) === null || _a === void 0 ? void 0 : _a.cmEditor) == cm) {
            return leafs[i].view.file;
        }
    }
    return null;
};

class OzanImagePlugin extends obsidian.Plugin {
    constructor() {
        super(...arguments);
        // Line Edit Changes
        this.codemirrorLineChanges = (cm, change) => {
            this.check_lines(cm, change.from.line, change.from.line + change.text.length - 1);
        };
        // Only Triggered during initial Load
        this.handleInitialLoad = (cm) => {
            var lastLine = cm.lastLine();
            var file = getFileCmBelongsTo(cm, this.app.workspace);
            for (let i = 0; i < lastLine; i++) {
                this.check_line(cm, i, file);
            }
        };
        // Check Single Line
        this.check_line = (cm, line_number, targetFile) => {
            // Regex for [[ ]] format
            const image_line_regex_1 = /!\[\[.*(jpe?g|png|gif|svg).*\]\]/;
            // Regex for ![ ]( ) format
            const image_line_regex_2 = /!\[(^$|.*)\]\(.*(jpe?g|png|gif|svg)\)/;
            // Get the Line edited
            const line = cm.lineInfo(line_number);
            if (line === null)
                return;
            // Current Line Comparison with Regex
            const match_1 = line.text.match(image_line_regex_1);
            const match_2 = line.text.match(image_line_regex_2);
            // Clear the widget if link was removed
            var line_image_widget = line.widgets ? line.widgets.filter((wid) => wid.className === 'oz-image-widget') : false;
            if (line_image_widget && (!match_1 || !match_2))
                line_image_widget[0].clear();
            // If any of regex matches, it will add image widget
            if (match_1 || match_2) {
                // Clear the image widgets if exists
                if (line.widgets) {
                    for (const wid of line.widgets) {
                        if (wid.className === 'oz-image-widget') {
                            wid.clear();
                        }
                    }
                }
                // Get the file name and alt text depending on format
                var filename = '';
                var alt = '';
                if (match_1) {
                    // Regex for [[myimage.jpg|#x-small]] format
                    filename = getFileNameAndAltText(1, match_1).fileName;
                    alt = getFileNameAndAltText(1, match_1).altText;
                }
                else if (match_2) {
                    // Regex for ![#x-small](myimage.jpg) format
                    filename = getFileNameAndAltText(2, match_2).fileName;
                    alt = getFileNameAndAltText(2, match_2).altText;
                }
                // Create Image
                const img = document.createElement('img');
                // Prepare the src for the Image
                if (filename_is_a_link(filename)) {
                    img.src = filename;
                }
                else {
                    // Source Path
                    var sourcePath = '';
                    if (targetFile != null) {
                        sourcePath = targetFile.path;
                    }
                    else {
                        let activeNoteFile = getActiveNoteFile(this.app.workspace);
                        sourcePath = activeNoteFile ? activeNoteFile.path : '';
                    }
                    var image = this.app.metadataCache.getFirstLinkpathDest(decodeURIComponent(filename), sourcePath);
                    if (image != null)
                        img.src = getPathOfImage(this.app.vault, image);
                }
                // Image Properties
                img.alt = alt;
                // Add Image widget under the Image Markdown
                cm.addLineWidget(line_number, img, { className: 'oz-image-widget' });
            }
        };
        // Check All Lines Function
        this.check_lines = (cm, from, to) => {
            // Last Used Line Number in Code Mirror
            var file = getFileCmBelongsTo(cm, this.app.workspace);
            for (let i = from; i <= to; i++) {
                this.check_line(cm, i, file);
            }
        };
    }
    onload() {
        // Register event for each change
        this.registerCodeMirror((cm) => {
            cm.on("change", this.codemirrorLineChanges);
            this.handleInitialLoad(cm);
        });
    }
    onunload() {
        this.app.workspace.iterateCodeMirrors((cm) => {
            cm.on("change", this.codemirrorLineChanges);
            clearWidges(cm);
        });
        new obsidian.Notice('Image in Editor Plugin is unloaded');
    }
}

module.exports = OzanImagePlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXMiOlsic3JjL3V0aWxzLnRzIiwic3JjL21haW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV29ya3NwYWNlLCBNYXJrZG93blZpZXcsIFZhdWx0LCBURmlsZSwgbm9ybWFsaXplUGF0aCB9IGZyb20gJ29ic2lkaWFuJztcblxuLy8gUmVtb3ZlIFdpZGdldHMgaW4gQ29kZU1pcnJvciBFZGl0b3JcbmNvbnN0IGNsZWFyV2lkZ2VzID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvcikgPT4ge1xuICAgIHZhciBsYXN0TGluZSA9IGNtLmxhc3RMaW5lKCk7XG5cbiAgICBmb3IobGV0IGk9MDsgaSA8PSBsYXN0TGluZTsgaSsrKXtcbiAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50IExpbmVcbiAgICAgICAgY29uc3QgbGluZSA9IGNtLmxpbmVJbmZvKGkpO1xuICAgICAgICAvLyBDbGVhciB0aGUgaW1hZ2Ugd2lkZ2V0cyBpZiBleGlzdHNcbiAgICAgICAgaWYgKGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICBmb3IoY29uc3Qgd2lkIG9mIGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgaWYgKHdpZC5jbGFzc05hbWUgPT09ICdvei1pbWFnZS13aWRnZXQnKXtcbiAgICAgICAgICAgICAgICAgICAgd2lkLmNsZWFyKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vIEh0dHAsIEh0dHBzIExpbmsgQ2hlY2tcbmNvbnN0IGZpbGVuYW1lX2lzX2FfbGluayA9IChmaWxlbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgdXJsX3JlZ2V4ID0gL15bYS16XVthLXowLTkrXFwtLl0rOi9pXG4gICAgcmV0dXJuIGZpbGVuYW1lLm1hdGNoKHVybF9yZWdleCkgIT0gbnVsbFxufTtcblxuIC8vIEltYWdlIE5hbWUgYW5kIEFsdCBUZXh0XG5jb25zdCBnZXRGaWxlTmFtZUFuZEFsdFRleHQgPShsaW5rVHlwZTogbnVtYmVyLCBtYXRjaDogYW55KSA9PiB7XG4gICAgLyogXG4gICAgICAgbGlua1R5cGUgMTogW1tteWltYWdlLmpwZ3wjeC1zbWFsbF1dXG4gICAgICAgbGlua1R5cGUyOiAhWyN4LXNtYWxsXShteWltYWdlLmpwZykgXG4gICAgICAgcmV0dXJucyB7IGZpbGVOYW1lOiAnJywgYWx0VGV4dDogJycgfSAgIFxuICAgICovXG5cbiAgICB2YXIgZmlsZV9uYW1lX3JlZ2V4O1xuICAgIHZhciBhbHRfcmVnZXg7XG5cbiAgICBpZihsaW5rVHlwZSA9PSAxKXtcbiAgICAgICAgZmlsZV9uYW1lX3JlZ2V4ID0gLyg/PD1cXFtcXFspLiooanBlP2d8cG5nfGdpZnxzdmcpLztcbiAgICAgICAgYWx0X3JlZ2V4ID0gLyg/PD1cXHwpLiooPz1dXSkvO1xuICAgIH0gZWxzZSBpZihsaW5rVHlwZSA9PSAyKXtcbiAgICAgICAgZmlsZV9uYW1lX3JlZ2V4ID0gLyg/PD1cXCgpLiooanBlP2d8cG5nfGdpZnxzdmcpLztcbiAgICAgICAgYWx0X3JlZ2V4ID0gLyg/PD1cXFspKF4kfC4qKSg/PVxcXSkvO1xuICAgIH1cblxuICAgIHZhciBmaWxlX21hdGNoID0gbWF0Y2hbMF0ubWF0Y2goZmlsZV9uYW1lX3JlZ2V4KTtcbiAgICB2YXIgYWx0X21hdGNoID0gbWF0Y2hbMF0ubWF0Y2goYWx0X3JlZ2V4KTtcblxuICAgIHJldHVybiB7IGZpbGVOYW1lOiBmaWxlX21hdGNoID8gZmlsZV9tYXRjaFswXSA6ICcnLCBcbiAgICAgICAgICAgIGFsdFRleHQ6IGFsdF9tYXRjaCA/IGFsdF9tYXRjaFswXSA6ICcnIH1cblxufSAgICBcblxuLy8gR2V0dGluZyBBY3RpdmUgTWFya2Rvd24gRmlsZVxuY29uc3QgZ2V0QWN0aXZlTm90ZUZpbGUgPSAod29ya3NwYWNlOiBXb3Jrc3BhY2UpID0+IHtcbiAgICByZXR1cm4gd29ya3NwYWNlLmdldEFjdGl2ZUZpbGUoKTtcbn1cblxuLy8gR2V0IEFjdGl2ZSBFZGl0b3JcbmNvbnN0IGdldENtRWRpdG9yID0gKHdvcmtzcGFjZTogV29ya3NwYWNlKTogQ29kZU1pcnJvci5FZGl0b3IgPT4ge1xuICAgIHJldHVybiB3b3Jrc3BhY2UuZ2V0QWN0aXZlVmlld09mVHlwZShNYXJrZG93blZpZXcpPy5zb3VyY2VNb2RlPy5jbUVkaXRvclxufVxuXG5jb25zdCBnZXRQYXRoT2ZWYXVsdCA9ICh2YXVsdDogVmF1bHQpOiBzdHJpbmcgPT4ge1xuICAgIHZhciBwYXRoID0gdmF1bHQuYWRhcHRlci5iYXNlUGF0aDtcbiAgICBpZihwYXRoLnN0YXJ0c1dpdGgoJy8nKSkgcmV0dXJuICdhcHA6Ly9sb2NhbCcgKyBwYXRoXG4gICAgcmV0dXJuICdhcHA6Ly9sb2NhbC8nICsgcGF0aFxufVxuXG4vLyBUZW1wb3JhcnkgU29sdXRpb24gdW50aWwgZ2V0UmVzb3VyY2VQYXRoIGltcHJvdmVkIFxuY29uc3QgZ2V0UGF0aE9mSW1hZ2UgPSAodmF1bHQ6IFZhdWx0LCBpbWFnZTogVEZpbGUpID0+IHtcbiAgICAvLyB2YXVsdC5nZXRSZXNvdXJjZVBhdGgoaW1hZ2UpIFxuICAgIHJldHVybiBnZXRQYXRoT2ZWYXVsdCh2YXVsdCkgKyAnLycgKyBpbWFnZS5wYXRoXG59XG5cbmNvbnN0IGdldEZpbGVDbUJlbG9uZ3NUbyA9IChjbTogQ29kZU1pcnJvci5FZGl0b3IsIHdvcmtzcGFjZTogV29ya3NwYWNlKSA9PiB7XG4gICAgbGV0IGxlYWZzID0gd29ya3NwYWNlLmdldExlYXZlc09mVHlwZShcIm1hcmtkb3duXCIpO1xuICAgIGZvcihsZXQgaT0wOyBpIDwgbGVhZnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZihsZWFmc1tpXS52aWV3LnNvdXJjZU1vZGU/LmNtRWRpdG9yID09IGNtKXtcbiAgICAgICAgICAgIHJldHVybiBsZWFmc1tpXS52aWV3LmZpbGVcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn0gXG5cbmV4cG9ydCB7IGNsZWFyV2lkZ2VzLCBmaWxlbmFtZV9pc19hX2xpbmssIGdldEZpbGVOYW1lQW5kQWx0VGV4dCxcbiAgICBnZXRBY3RpdmVOb3RlRmlsZSwgZ2V0Q21FZGl0b3IsIGdldFBhdGhPZkltYWdlLCBnZXRGaWxlQ21CZWxvbmdzVG8gfTsiLCJpbXBvcnQgeyBQbHVnaW4sIE5vdGljZSwgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBjbGVhcldpZGdlcywgZmlsZW5hbWVfaXNfYV9saW5rLCBnZXRGaWxlTmFtZUFuZEFsdFRleHQsXG4gICAgICAgIGdldEFjdGl2ZU5vdGVGaWxlLCBnZXRQYXRoT2ZJbWFnZSwgZ2V0RmlsZUNtQmVsb25nc1RvIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE96YW5JbWFnZVBsdWdpbiBleHRlbmRzIFBsdWdpbntcblxuICAgIG9ubG9hZCgpe1xuICAgICAgICAvLyBSZWdpc3RlciBldmVudCBmb3IgZWFjaCBjaGFuZ2VcbiAgICAgICAgdGhpcy5yZWdpc3RlckNvZGVNaXJyb3IoIChjbTogQ29kZU1pcnJvci5FZGl0b3IpID0+IHtcbiAgICAgICAgICAgIGNtLm9uKFwiY2hhbmdlXCIsIHRoaXMuY29kZW1pcnJvckxpbmVDaGFuZ2VzKTtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlSW5pdGlhbExvYWQoY20pO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIG9udW5sb2FkKCl7XG4gICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5pdGVyYXRlQ29kZU1pcnJvcnMoIChjbSkgPT4ge1xuICAgICAgICAgICAgY20ub24oXCJjaGFuZ2VcIiwgdGhpcy5jb2RlbWlycm9yTGluZUNoYW5nZXMpO1xuICAgICAgICAgICAgY2xlYXJXaWRnZXMoY20pO1xuICAgICAgICB9KTtcbiAgICAgICAgbmV3IE5vdGljZSgnSW1hZ2UgaW4gRWRpdG9yIFBsdWdpbiBpcyB1bmxvYWRlZCcpO1xuICAgIH1cblxuICAgIC8vIExpbmUgRWRpdCBDaGFuZ2VzXG4gICAgY29kZW1pcnJvckxpbmVDaGFuZ2VzID0gKGNtOiBhbnksIGNoYW5nZTogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuY2hlY2tfbGluZXMoY20sIGNoYW5nZS5mcm9tLmxpbmUsIGNoYW5nZS5mcm9tLmxpbmUgKyBjaGFuZ2UudGV4dC5sZW5ndGggLSAxKTtcbiAgICB9XG5cbiAgICAvLyBPbmx5IFRyaWdnZXJlZCBkdXJpbmcgaW5pdGlhbCBMb2FkXG4gICAgaGFuZGxlSW5pdGlhbExvYWQgPSAoY206IENvZGVNaXJyb3IuRWRpdG9yKSA9PiB7XG4gICAgICAgIHZhciBsYXN0TGluZSA9IGNtLmxhc3RMaW5lKCk7XG4gICAgICAgIHZhciBmaWxlID0gZ2V0RmlsZUNtQmVsb25nc1RvKGNtLCB0aGlzLmFwcC53b3Jrc3BhY2UpO1xuICAgICAgICBmb3IobGV0IGk9MDsgaSA8IGxhc3RMaW5lOyBpKyspe1xuICAgICAgICAgICAgdGhpcy5jaGVja19saW5lKGNtLCBpLCBmaWxlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIFNpbmdsZSBMaW5lXG4gICAgY2hlY2tfbGluZTogYW55ID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvciwgbGluZV9udW1iZXI6IG51bWJlciwgdGFyZ2V0RmlsZTpURmlsZSkgPT4ge1xuXG4gICAgICAgIC8vIFJlZ2V4IGZvciBbWyBdXSBmb3JtYXRcbiAgICAgICAgY29uc3QgaW1hZ2VfbGluZV9yZWdleF8xID0gLyFcXFtcXFsuKihqcGU/Z3xwbmd8Z2lmfHN2ZykuKlxcXVxcXS9cbiAgICAgICAgLy8gUmVnZXggZm9yICFbIF0oICkgZm9ybWF0XG4gICAgICAgIGNvbnN0IGltYWdlX2xpbmVfcmVnZXhfMiA9IC8hXFxbKF4kfC4qKVxcXVxcKC4qKGpwZT9nfHBuZ3xnaWZ8c3ZnKVxcKS9cbiAgICAgICAgLy8gR2V0IHRoZSBMaW5lIGVkaXRlZFxuICAgICAgICBjb25zdCBsaW5lID0gY20ubGluZUluZm8obGluZV9udW1iZXIpO1xuICAgICAgICBcbiAgICAgICAgaWYobGluZSA9PT0gbnVsbCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIEN1cnJlbnQgTGluZSBDb21wYXJpc29uIHdpdGggUmVnZXhcbiAgICAgICAgY29uc3QgbWF0Y2hfMSA9IGxpbmUudGV4dC5tYXRjaChpbWFnZV9saW5lX3JlZ2V4XzEpO1xuICAgICAgICBjb25zdCBtYXRjaF8yID0gbGluZS50ZXh0Lm1hdGNoKGltYWdlX2xpbmVfcmVnZXhfMik7XG5cbiAgICAgICAgLy8gQ2xlYXIgdGhlIHdpZGdldCBpZiBsaW5rIHdhcyByZW1vdmVkXG4gICAgICAgIHZhciBsaW5lX2ltYWdlX3dpZGdldCA9IGxpbmUud2lkZ2V0cyA/IGxpbmUud2lkZ2V0cy5maWx0ZXIoKHdpZDogeyBjbGFzc05hbWU6IHN0cmluZzsgfSkgPT4gd2lkLmNsYXNzTmFtZSA9PT0gJ296LWltYWdlLXdpZGdldCcpIDogZmFsc2U7XG4gICAgICAgIGlmKGxpbmVfaW1hZ2Vfd2lkZ2V0ICYmICghbWF0Y2hfMSB8fCAhbWF0Y2hfMikpIGxpbmVfaW1hZ2Vfd2lkZ2V0WzBdLmNsZWFyKCk7XG5cbiAgICAgICAgLy8gSWYgYW55IG9mIHJlZ2V4IG1hdGNoZXMsIGl0IHdpbGwgYWRkIGltYWdlIHdpZGdldFxuICAgICAgICBpZihtYXRjaF8xIHx8IG1hdGNoXzIpe1xuICAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYXIgdGhlIGltYWdlIHdpZGdldHMgaWYgZXhpc3RzXG4gICAgICAgICAgICBpZiAobGluZS53aWRnZXRzKXtcbiAgICAgICAgICAgICAgICBmb3IoY29uc3Qgd2lkIG9mIGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgICAgIGlmICh3aWQuY2xhc3NOYW1lID09PSAnb3otaW1hZ2Utd2lkZ2V0Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWQuY2xlYXIoKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBHZXQgdGhlIGZpbGUgbmFtZSBhbmQgYWx0IHRleHQgZGVwZW5kaW5nIG9uIGZvcm1hdFxuICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gJyc7XG4gICAgICAgICAgICB2YXIgYWx0ID0gJyc7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmKG1hdGNoXzEpe1xuICAgICAgICAgICAgICAgIC8vIFJlZ2V4IGZvciBbW215aW1hZ2UuanBnfCN4LXNtYWxsXV0gZm9ybWF0XG4gICAgICAgICAgICAgICAgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMSwgbWF0Y2hfMSkuZmlsZU5hbWVcbiAgICAgICAgICAgICAgICBhbHQgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMSwgbWF0Y2hfMSkuYWx0VGV4dFxuICAgICAgICAgICAgfSBlbHNlIGlmKG1hdGNoXzIpe1xuICAgICAgICAgICAgICAgIC8vIFJlZ2V4IGZvciAhWyN4LXNtYWxsXShteWltYWdlLmpwZykgZm9ybWF0XG4gICAgICAgICAgICAgICAgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMiwgbWF0Y2hfMikuZmlsZU5hbWVcbiAgICAgICAgICAgICAgICBhbHQgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMiwgbWF0Y2hfMikuYWx0VGV4dFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBDcmVhdGUgSW1hZ2VcbiAgICAgICAgICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuXG4gICAgICAgICAgICAvLyBQcmVwYXJlIHRoZSBzcmMgZm9yIHRoZSBJbWFnZVxuICAgICAgICAgICAgaWYoZmlsZW5hbWVfaXNfYV9saW5rKGZpbGVuYW1lKSl7XG4gICAgICAgICAgICAgICAgaW1nLnNyYyA9IGZpbGVuYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBTb3VyY2UgUGF0aFxuICAgICAgICAgICAgICAgIHZhciBzb3VyY2VQYXRoID0gJyc7XG4gICAgICAgICAgICAgICAgaWYodGFyZ2V0RmlsZSAhPSBudWxsKXtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aCA9IHRhcmdldEZpbGUucGF0aDtcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGl2ZU5vdGVGaWxlID0gZ2V0QWN0aXZlTm90ZUZpbGUodGhpcy5hcHAud29ya3NwYWNlKTtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aCA9IGFjdGl2ZU5vdGVGaWxlID8gYWN0aXZlTm90ZUZpbGUucGF0aCA6ICcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpcnN0TGlua3BhdGhEZXN0KGRlY29kZVVSSUNvbXBvbmVudChmaWxlbmFtZSksIHNvdXJjZVBhdGgpO1xuICAgICAgICAgICAgICAgIGlmKGltYWdlICE9IG51bGwpIGltZy5zcmMgPSBnZXRQYXRoT2ZJbWFnZSh0aGlzLmFwcC52YXVsdCwgaW1hZ2UpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEltYWdlIFByb3BlcnRpZXNcbiAgICAgICAgICAgIGltZy5hbHQgPSBhbHQ7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEFkZCBJbWFnZSB3aWRnZXQgdW5kZXIgdGhlIEltYWdlIE1hcmtkb3duXG4gICAgICAgICAgICBjbS5hZGRMaW5lV2lkZ2V0KGxpbmVfbnVtYmVyLCBpbWcsIHtjbGFzc05hbWU6ICdvei1pbWFnZS13aWRnZXQnfSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBBbGwgTGluZXMgRnVuY3Rpb25cbiAgICBjaGVja19saW5lczogYW55ID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvciwgZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyKSA9PiB7XG4gICAgICAgIC8vIExhc3QgVXNlZCBMaW5lIE51bWJlciBpbiBDb2RlIE1pcnJvclxuICAgICAgICB2YXIgZmlsZSA9IGdldEZpbGVDbUJlbG9uZ3NUbyhjbSwgdGhpcy5hcHAud29ya3NwYWNlKTtcbiAgICAgICAgZm9yKGxldCBpPWZyb207IGkgPD0gdG87IGkrKyl7XG4gICAgICAgICAgICB0aGlzLmNoZWNrX2xpbmUoY20sIGksIGZpbGUpO1xuICAgICAgICB9XG4gICAgfVxufSJdLCJuYW1lcyI6WyJQbHVnaW4iLCJOb3RpY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUVBO0FBQ0EsTUFBTSxXQUFXLEdBQUcsQ0FBQyxFQUFxQjtJQUN0QyxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7SUFFN0IsS0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBQzs7UUFFNUIsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7UUFFNUIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFDO1lBQ2IsS0FBSSxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFDO2dCQUMxQixJQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssaUJBQWlCLEVBQUM7b0JBQ3BDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtpQkFDZDthQUNKO1NBQ0o7S0FDSjtBQUNMLENBQUMsQ0FBQTtBQUVEO0FBQ0EsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLFFBQWdCO0lBQ3hDLE1BQU0sU0FBUyxHQUFHLHVCQUF1QixDQUFBO0lBQ3pDLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUE7QUFDNUMsQ0FBQyxDQUFDO0FBRUQ7QUFDRCxNQUFNLHFCQUFxQixHQUFFLENBQUMsUUFBZ0IsRUFBRSxLQUFVOzs7Ozs7SUFPdEQsSUFBSSxlQUFlLENBQUM7SUFDcEIsSUFBSSxTQUFTLENBQUM7SUFFZCxJQUFH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
