/*
THIS IS A GENERATED/BUNDLED FILE BY ROLLUP
if you want to view the source visit the plugins github repository
*/

'use strict';

var obsidian = require('obsidian');

// Remove Widgets in CodeMirror Editor
const clearWidges = (cm) => {
    var lastLine = cm.lastLine();
    for (let i = 0; i <= lastLine; i++) {
        // Get the current Line
        const line = cm.lineInfo(i);
        // Clear the image widgets if exists
        if (line.widgets) {
            for (const wid of line.widgets) {
                if (wid.className === 'oz-image-widget') {
                    wid.clear();
                }
            }
        }
    }
};
// Http, Https Link Check
const filename_is_a_link = (filename) => filename.startsWith('http');
// Image Name and Alt Text
const getFileNameAndAltText = (linkType, match) => {
    /*
       linkType 1: [[myimage.jpg|#x-small]]
       linkType2: ![#x-small](myimage.jpg)
       returns { fileName: '', altText: '' }
    */
    var file_name_regex;
    var alt_regex;
    if (linkType == 1) {
        file_name_regex = /(?<=\[\[).*(jpe?g|png|gif)/;
        alt_regex = /(?<=\|).*(?=]])/;
    }
    else if (linkType == 2) {
        file_name_regex = /(?<=\().*(jpe?g|png|gif)/;
        alt_regex = /(?<=\[)(^$|.*)(?=\])/;
    }
    var file_match = match[0].match(file_name_regex);
    var alt_match = match[0].match(alt_regex);
    return { fileName: file_match ? file_match[0] : '',
        altText: alt_match ? alt_match[0] : '' };
};
// Getting Active Markdown File
const getActiveNoteFile = (workspace) => {
    return workspace.activeLeaf.view.file;
};
// Get Active Editor
const getCmEditor = (workspace) => {
    var _a, _b;
    return (_b = (_a = workspace.getActiveViewOfType(obsidian.MarkdownView)) === null || _a === void 0 ? void 0 : _a.sourceMode) === null || _b === void 0 ? void 0 : _b.cmEditor;
};
const getPathOfVault = (vault) => {
    return 'app://local' + vault.adapter.basePath;
};
// Temporary Solution until getResourcePath improved 
const getPathOfImage = (vault, image) => {
    // this.app.vault.getResourcePath(image) 
    return getPathOfVault(vault) + '/' + image.path;
};

class OzanImagePlugin extends obsidian.Plugin {
    constructor() {
        super(...arguments);
        this.codemirrorLineChanges = (cm, changes) => {
            changes.some((change) => {
                this.check_line(cm, change.to.line);
            });
        };
        this.codemirrorScreenChange = (cm) => {
            return this.check_lines(cm);
        };
        // Check Single Line
        this.check_line = (cm, line_number, targetFile) => {
            // Regex for [[ ]] format
            const image_line_regex_1 = /!\[\[.*(jpe?g|png|gif).*\]\]/;
            // Regex for ![ ]( ) format
            const image_line_regex_2 = /!\[(^$|.*)\]\(.*(jpe?g|png|gif)\)/;
            // Get the Line edited
            const line = cm.lineInfo(line_number);
            if (line === null)
                return;
            // Current Line Comparison with Regex
            const match_1 = line.text.match(image_line_regex_1);
            const match_2 = line.text.match(image_line_regex_2);
            // Clear the widget if link was removed
            var line_image_widget = line.widgets ? line.widgets.filter((wid) => wid.className === 'oz-image-widget') : false;
            if (line_image_widget && (!match_1 || !match_2))
                line_image_widget[0].clear();
            // If any of regex matches, it will add image widget
            if (match_1 || match_2) {
                // Clear the image widgets if exists
                if (line.widgets) {
                    for (const wid of line.widgets) {
                        if (wid.className === 'oz-image-widget') {
                            wid.clear();
                        }
                    }
                }
                // Get the file name and alt text depending on format
                var filename = '';
                var alt = '';
                if (match_1) {
                    // Regex for [[myimage.jpg|#x-small]] format
                    filename = getFileNameAndAltText(1, match_1).fileName;
                    alt = getFileNameAndAltText(1, match_1).altText;
                }
                else if (match_2) {
                    // Regex for ![#x-small](myimage.jpg) format
                    filename = getFileNameAndAltText(2, match_2).fileName;
                    alt = getFileNameAndAltText(2, match_2).altText;
                }
                // Create Image
                const img = document.createElement('img');
                // Prepare the src for the Image
                if (filename_is_a_link(filename)) {
                    img.src = filename;
                }
                else {
                    // Source Path
                    var sourcePath = '';
                    if (targetFile) {
                        sourcePath = targetFile.path;
                    }
                    else {
                        sourcePath = getActiveNoteFile(this.app.workspace).path;
                    }
                    var image = this.app.metadataCache.getFirstLinkpathDest(decodeURIComponent(filename), sourcePath);
                    if (image != null)
                        img.src = getPathOfImage(this.app.vault, image);
                }
                // Image Properties
                img.alt = alt;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                // Add Image widget under the Image Markdown
                cm.addLineWidget(line_number, img, { className: 'oz-image-widget' });
            }
        };
        // Check All Lines Function
        this.check_lines = (cm, targetFile) => {
            // Last Used Line Number in Code Mirror
            var lastLine = cm.lastLine();
            for (let i = 0; i <= lastLine; i++) {
                if (obsidian.TFile) {
                    this.check_line(cm, i);
                }
                else {
                    this.check_line(cm, i, obsidian.TFile);
                }
            }
        };
        // Handle file after file-open event
        this.handleFile = (targetFile) => {
            // If the file fired is a markdown file
            if (targetFile.extension === 'md') {
                // Get the open CodeMirror to check the lines
                this.check_lines(getCmEditor(this.app.workspace), targetFile);
            }
        };
    }
    onload() {
        // Each file open will fire
        this.registerEvent(this.app.workspace.on("file-open", this.handleFile));
        // Register event for each change
        this.registerCodeMirror((cm) => {
            cm.on("changes", this.codemirrorLineChanges);
        });
        // Check the active CodeMirror during load
        this.app.workspace.iterateCodeMirrors((cm) => {
            this.check_lines(cm);
        });
    }
    onunload() {
        this.app.workspace.iterateCodeMirrors((cm) => {
            this.app.workspace.off("file-open", this.handleFile);
            cm.off("changes", this.codemirrorLineChanges);
            clearWidges(cm);
        });
        new obsidian.Notice('Image in Editor Plugin is unloaded');
    }
}

module.exports = OzanImagePlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXMiOlsic3JjL3V0aWxzLnRzIiwic3JjL21haW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV29ya3NwYWNlLCBNYXJrZG93blZpZXcsIFZhdWx0LCBURmlsZSwgbm9ybWFsaXplUGF0aCB9IGZyb20gJ29ic2lkaWFuJztcblxuLy8gUmVtb3ZlIFdpZGdldHMgaW4gQ29kZU1pcnJvciBFZGl0b3JcbmNvbnN0IGNsZWFyV2lkZ2VzID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvcikgPT4ge1xuXG4gICAgdmFyIGxhc3RMaW5lID0gY20ubGFzdExpbmUoKTtcblxuICAgIGZvcihsZXQgaT0wOyBpIDw9IGxhc3RMaW5lOyBpKyspe1xuXG4gICAgICAgIC8vIEdldCB0aGUgY3VycmVudCBMaW5lXG4gICAgICAgIGNvbnN0IGxpbmUgPSBjbS5saW5lSW5mbyhpKTtcblxuICAgICAgICAvLyBDbGVhciB0aGUgaW1hZ2Ugd2lkZ2V0cyBpZiBleGlzdHNcbiAgICAgICAgaWYgKGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICBmb3IoY29uc3Qgd2lkIG9mIGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgaWYgKHdpZC5jbGFzc05hbWUgPT09ICdvei1pbWFnZS13aWRnZXQnKXtcbiAgICAgICAgICAgICAgICAgICAgd2lkLmNsZWFyKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfVxufVxuXG4vLyBIdHRwLCBIdHRwcyBMaW5rIENoZWNrXG5jb25zdCBmaWxlbmFtZV9pc19hX2xpbmsgPSAoZmlsZW5hbWU6IHN0cmluZykgPT4gZmlsZW5hbWUuc3RhcnRzV2l0aCgnaHR0cCcpO1xuXG4gLy8gSW1hZ2UgTmFtZSBhbmQgQWx0IFRleHRcbmNvbnN0IGdldEZpbGVOYW1lQW5kQWx0VGV4dCA9KGxpbmtUeXBlOiBudW1iZXIsIG1hdGNoOiBhbnkpID0+IHtcblxuICAgIC8qIFxuICAgICAgIGxpbmtUeXBlIDE6IFtbbXlpbWFnZS5qcGd8I3gtc21hbGxdXVxuICAgICAgIGxpbmtUeXBlMjogIVsjeC1zbWFsbF0obXlpbWFnZS5qcGcpIFxuICAgICAgIHJldHVybnMgeyBmaWxlTmFtZTogJycsIGFsdFRleHQ6ICcnIH0gICBcbiAgICAqL1xuXG4gICAgdmFyIGZpbGVfbmFtZV9yZWdleDtcbiAgICB2YXIgYWx0X3JlZ2V4O1xuXG4gICAgaWYobGlua1R5cGUgPT0gMSl7XG4gICAgICAgIGZpbGVfbmFtZV9yZWdleCA9IC8oPzw9XFxbXFxbKS4qKGpwZT9nfHBuZ3xnaWYpLztcbiAgICAgICAgYWx0X3JlZ2V4ID0gLyg/PD1cXHwpLiooPz1dXSkvO1xuICAgIH0gZWxzZSBpZihsaW5rVHlwZSA9PSAyKXtcbiAgICAgICAgZmlsZV9uYW1lX3JlZ2V4ID0gLyg/PD1cXCgpLiooanBlP2d8cG5nfGdpZikvO1xuICAgICAgICBhbHRfcmVnZXggPSAvKD88PVxcWykoXiR8LiopKD89XFxdKS87XG4gICAgfVxuXG4gICAgdmFyIGZpbGVfbWF0Y2ggPSBtYXRjaFswXS5tYXRjaChmaWxlX25hbWVfcmVnZXgpO1xuICAgIHZhciBhbHRfbWF0Y2ggPSBtYXRjaFswXS5tYXRjaChhbHRfcmVnZXgpO1xuXG4gICAgcmV0dXJuIHsgZmlsZU5hbWU6IGZpbGVfbWF0Y2ggPyBmaWxlX21hdGNoWzBdIDogJycsIFxuICAgICAgICAgICAgYWx0VGV4dDogYWx0X21hdGNoID8gYWx0X21hdGNoWzBdIDogJycgfVxuXG59ICAgIFxuXG4vLyBHZXR0aW5nIEFjdGl2ZSBNYXJrZG93biBGaWxlXG5jb25zdCBnZXRBY3RpdmVOb3RlRmlsZSA9ICh3b3Jrc3BhY2U6IFdvcmtzcGFjZSkgPT4ge1xuICAgIHJldHVybiAod29ya3NwYWNlLmFjdGl2ZUxlYWYudmlldyBhcyBNYXJrZG93blZpZXcpLmZpbGU7XG59XG5cbi8vIEdldCBBY3RpdmUgRWRpdG9yXG5jb25zdCBnZXRDbUVkaXRvciA9ICh3b3Jrc3BhY2U6IFdvcmtzcGFjZSk6IENvZGVNaXJyb3IuRWRpdG9yID0+IHtcbiAgICByZXR1cm4gd29ya3NwYWNlLmdldEFjdGl2ZVZpZXdPZlR5cGUoTWFya2Rvd25WaWV3KT8uc291cmNlTW9kZT8uY21FZGl0b3Jcbn1cblxuY29uc3QgZ2V0UGF0aE9mVmF1bHQgPSAodmF1bHQ6IFZhdWx0KTogc3RyaW5nID0+IHtcbiAgICByZXR1cm4gJ2FwcDovL2xvY2FsJyArIHZhdWx0LmFkYXB0ZXIuYmFzZVBhdGhcbn1cblxuLy8gVGVtcG9yYXJ5IFNvbHV0aW9uIHVudGlsIGdldFJlc291cmNlUGF0aCBpbXByb3ZlZCBcbmNvbnN0IGdldFBhdGhPZkltYWdlID0gKHZhdWx0OiBWYXVsdCwgaW1hZ2U6IFRGaWxlKSA9PiB7XG4gICAgLy8gdGhpcy5hcHAudmF1bHQuZ2V0UmVzb3VyY2VQYXRoKGltYWdlKSBcbiAgICByZXR1cm4gZ2V0UGF0aE9mVmF1bHQodmF1bHQpICsgJy8nICsgaW1hZ2UucGF0aFxufVxuXG5leHBvcnQgeyBjbGVhcldpZGdlcywgZmlsZW5hbWVfaXNfYV9saW5rLCBnZXRGaWxlTmFtZUFuZEFsdFRleHQsXG4gICAgZ2V0QWN0aXZlTm90ZUZpbGUsIGdldENtRWRpdG9yLCBnZXRQYXRoT2ZJbWFnZSB9OyIsImltcG9ydCB7IFBsdWdpbiwgTm90aWNlLCBURmlsZSB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IGNsZWFyV2lkZ2VzLCBmaWxlbmFtZV9pc19hX2xpbmssIGdldEZpbGVOYW1lQW5kQWx0VGV4dCxcbiAgICAgICAgZ2V0QWN0aXZlTm90ZUZpbGUsIGdldENtRWRpdG9yLCBnZXRQYXRoT2ZJbWFnZSB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPemFuSW1hZ2VQbHVnaW4gZXh0ZW5kcyBQbHVnaW57XG5cbiAgICBvbmxvYWQoKXtcbiAgICAgICAgLy8gRWFjaCBmaWxlIG9wZW4gd2lsbCBmaXJlXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudChcbiAgICAgICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5vbihcImZpbGUtb3BlblwiLCB0aGlzLmhhbmRsZUZpbGUpXG4gICAgICAgIClcbiAgICAgICAgLy8gUmVnaXN0ZXIgZXZlbnQgZm9yIGVhY2ggY2hhbmdlXG4gICAgICAgIHRoaXMucmVnaXN0ZXJDb2RlTWlycm9yKCAoY206IENvZGVNaXJyb3IuRWRpdG9yKSA9PiB7XG4gICAgICAgICAgICBjbS5vbihcImNoYW5nZXNcIiwgdGhpcy5jb2RlbWlycm9yTGluZUNoYW5nZXMpO1xuICAgICAgICB9KVxuICAgICAgICAvLyBDaGVjayB0aGUgYWN0aXZlIENvZGVNaXJyb3IgZHVyaW5nIGxvYWRcbiAgICAgICAgdGhpcy5hcHAud29ya3NwYWNlLml0ZXJhdGVDb2RlTWlycm9ycyggKGNtKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNoZWNrX2xpbmVzKGNtKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBjb2RlbWlycm9yTGluZUNoYW5nZXMgPSAoY206IGFueSwgY2hhbmdlczogYW55KSA9PiB7XG4gICAgICAgIGNoYW5nZXMuc29tZSggKGNoYW5nZTogYW55KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNoZWNrX2xpbmUoY20sIGNoYW5nZS50by5saW5lKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBjb2RlbWlycm9yU2NyZWVuQ2hhbmdlID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvcikgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jaGVja19saW5lcyhjbSk7XG4gICAgfVxuXG4gICAgb251bmxvYWQoKXtcbiAgICAgICAgdGhpcy5hcHAud29ya3NwYWNlLml0ZXJhdGVDb2RlTWlycm9ycyggKGNtKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFwcC53b3Jrc3BhY2Uub2ZmKFwiZmlsZS1vcGVuXCIsIHRoaXMuaGFuZGxlRmlsZSk7XG4gICAgICAgICAgICBjbS5vZmYoXCJjaGFuZ2VzXCIsIHRoaXMuY29kZW1pcnJvckxpbmVDaGFuZ2VzKTtcbiAgICAgICAgICAgIGNsZWFyV2lkZ2VzKGNtKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG5ldyBOb3RpY2UoJ0ltYWdlIGluIEVkaXRvciBQbHVnaW4gaXMgdW5sb2FkZWQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBTaW5nbGUgTGluZVxuICAgIGNoZWNrX2xpbmU6IGFueSA9IChjbTogQ29kZU1pcnJvci5FZGl0b3IsIGxpbmVfbnVtYmVyOiBudW1iZXIsIHRhcmdldEZpbGU/OlRGaWxlKSA9PiB7XG5cbiAgICAgICAgLy8gUmVnZXggZm9yIFtbIF1dIGZvcm1hdFxuICAgICAgICBjb25zdCBpbWFnZV9saW5lX3JlZ2V4XzEgPSAvIVxcW1xcWy4qKGpwZT9nfHBuZ3xnaWYpLipcXF1cXF0vXG4gICAgICAgIC8vIFJlZ2V4IGZvciAhWyBdKCApIGZvcm1hdFxuICAgICAgICBjb25zdCBpbWFnZV9saW5lX3JlZ2V4XzIgPSAvIVxcWyheJHwuKilcXF1cXCguKihqcGU/Z3xwbmd8Z2lmKVxcKS9cbiAgICAgICAgLy8gR2V0IHRoZSBMaW5lIGVkaXRlZFxuICAgICAgICBjb25zdCBsaW5lID0gY20ubGluZUluZm8obGluZV9udW1iZXIpO1xuICAgICAgICBcbiAgICAgICAgaWYobGluZSA9PT0gbnVsbCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIEN1cnJlbnQgTGluZSBDb21wYXJpc29uIHdpdGggUmVnZXhcbiAgICAgICAgY29uc3QgbWF0Y2hfMSA9IGxpbmUudGV4dC5tYXRjaChpbWFnZV9saW5lX3JlZ2V4XzEpO1xuICAgICAgICBjb25zdCBtYXRjaF8yID0gbGluZS50ZXh0Lm1hdGNoKGltYWdlX2xpbmVfcmVnZXhfMik7XG5cbiAgICAgICAgLy8gQ2xlYXIgdGhlIHdpZGdldCBpZiBsaW5rIHdhcyByZW1vdmVkXG4gICAgICAgIHZhciBsaW5lX2ltYWdlX3dpZGdldCA9IGxpbmUud2lkZ2V0cyA/IGxpbmUud2lkZ2V0cy5maWx0ZXIoKHdpZDogeyBjbGFzc05hbWU6IHN0cmluZzsgfSkgPT4gd2lkLmNsYXNzTmFtZSA9PT0gJ296LWltYWdlLXdpZGdldCcpIDogZmFsc2U7XG4gICAgICAgIGlmKGxpbmVfaW1hZ2Vfd2lkZ2V0ICYmICghbWF0Y2hfMSB8fCAhbWF0Y2hfMikpIGxpbmVfaW1hZ2Vfd2lkZ2V0WzBdLmNsZWFyKCk7XG5cbiAgICAgICAgLy8gSWYgYW55IG9mIHJlZ2V4IG1hdGNoZXMsIGl0IHdpbGwgYWRkIGltYWdlIHdpZGdldFxuICAgICAgICBpZihtYXRjaF8xIHx8IG1hdGNoXzIpe1xuICAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYXIgdGhlIGltYWdlIHdpZGdldHMgaWYgZXhpc3RzXG4gICAgICAgICAgICBpZiAobGluZS53aWRnZXRzKXtcbiAgICAgICAgICAgICAgICBmb3IoY29uc3Qgd2lkIG9mIGxpbmUud2lkZ2V0cyl7XG4gICAgICAgICAgICAgICAgICAgIGlmICh3aWQuY2xhc3NOYW1lID09PSAnb3otaW1hZ2Utd2lkZ2V0Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWQuY2xlYXIoKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBHZXQgdGhlIGZpbGUgbmFtZSBhbmQgYWx0IHRleHQgZGVwZW5kaW5nIG9uIGZvcm1hdFxuICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gJyc7XG4gICAgICAgICAgICB2YXIgYWx0ID0gJyc7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmKG1hdGNoXzEpe1xuICAgICAgICAgICAgICAgIC8vIFJlZ2V4IGZvciBbW215aW1hZ2UuanBnfCN4LXNtYWxsXV0gZm9ybWF0XG4gICAgICAgICAgICAgICAgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMSwgbWF0Y2hfMSkuZmlsZU5hbWVcbiAgICAgICAgICAgICAgICBhbHQgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMSwgbWF0Y2hfMSkuYWx0VGV4dFxuICAgICAgICAgICAgfSBlbHNlIGlmKG1hdGNoXzIpe1xuICAgICAgICAgICAgICAgIC8vIFJlZ2V4IGZvciAhWyN4LXNtYWxsXShteWltYWdlLmpwZykgZm9ybWF0XG4gICAgICAgICAgICAgICAgZmlsZW5hbWUgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMiwgbWF0Y2hfMikuZmlsZU5hbWVcbiAgICAgICAgICAgICAgICBhbHQgPSBnZXRGaWxlTmFtZUFuZEFsdFRleHQoMiwgbWF0Y2hfMikuYWx0VGV4dFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBDcmVhdGUgSW1hZ2VcbiAgICAgICAgICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuXG4gICAgICAgICAgICAvLyBQcmVwYXJlIHRoZSBzcmMgZm9yIHRoZSBJbWFnZVxuICAgICAgICAgICAgaWYoZmlsZW5hbWVfaXNfYV9saW5rKGZpbGVuYW1lKSl7XG4gICAgICAgICAgICAgICAgaW1nLnNyYyA9IGZpbGVuYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBTb3VyY2UgUGF0aFxuICAgICAgICAgICAgICAgIHZhciBzb3VyY2VQYXRoID0gJyc7XG4gICAgICAgICAgICAgICAgaWYodGFyZ2V0RmlsZSl7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGggPSB0YXJnZXRGaWxlLnBhdGg7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGggPSBnZXRBY3RpdmVOb3RlRmlsZSh0aGlzLmFwcC53b3Jrc3BhY2UpLnBhdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBpbWFnZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0Rmlyc3RMaW5rcGF0aERlc3QoZGVjb2RlVVJJQ29tcG9uZW50KGZpbGVuYW1lKSwgc291cmNlUGF0aCk7XG4gICAgICAgICAgICAgICAgaWYoaW1hZ2UgIT0gbnVsbCkgaW1nLnNyYyA9IGdldFBhdGhPZkltYWdlKHRoaXMuYXBwLnZhdWx0LCBpbWFnZSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gSW1hZ2UgUHJvcGVydGllc1xuICAgICAgICAgICAgaW1nLmFsdCA9IGFsdDtcbiAgICAgICAgICAgIGltZy5zdHlsZS5tYXhXaWR0aCA9ICcxMDAlJztcbiAgICAgICAgICAgIGltZy5zdHlsZS5oZWlnaHQgPSAnYXV0byc7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEFkZCBJbWFnZSB3aWRnZXQgdW5kZXIgdGhlIEltYWdlIE1hcmtkb3duXG4gICAgICAgICAgICBjbS5hZGRMaW5lV2lkZ2V0KGxpbmVfbnVtYmVyLCBpbWcsIHtjbGFzc05hbWU6ICdvei1pbWFnZS13aWRnZXQnfSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBBbGwgTGluZXMgRnVuY3Rpb25cbiAgICBjaGVja19saW5lczogYW55ID0gKGNtOiBDb2RlTWlycm9yLkVkaXRvciwgdGFyZ2V0RmlsZT86VEZpbGUpID0+IHtcbiAgICAgICAgLy8gTGFzdCBVc2VkIExpbmUgTnVtYmVyIGluIENvZGUgTWlycm9yXG4gICAgICAgIHZhciBsYXN0TGluZSA9IGNtLmxhc3RMaW5lKCk7XG4gICAgICAgIGZvcihsZXQgaT0wOyBpIDw9IGxhc3RMaW5lOyBpKyspe1xuICAgICAgICAgICAgaWYoVEZpbGUpe1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tfbGluZShjbSwgaSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tfbGluZShjbSwgaSwgVEZpbGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgICAgICBcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgZmlsZSBhZnRlciBmaWxlLW9wZW4gZXZlbnRcbiAgICBoYW5kbGVGaWxlID0gKHRhcmdldEZpbGU6IFRGaWxlKTogdm9pZCA9PiB7XG4gICAgICAgIC8vIElmIHRoZSBmaWxlIGZpcmVkIGlzIGEgbWFya2Rvd24gZmlsZVxuICAgICAgICBpZih0YXJnZXRGaWxlLmV4dGVuc2lvbiA9PT0gJ21kJyl7XG4gICAgICAgICAgICAvLyBHZXQgdGhlIG9wZW4gQ29kZU1pcnJvciB0byBjaGVjayB0aGUgbGluZXNcbiAgICAgICAgICAgIHRoaXMuY2hlY2tfbGluZXMoZ2V0Q21FZGl0b3IodGhpcy5hcHAud29ya3NwYWNlKSwgdGFyZ2V0RmlsZSk7XG4gICAgICAgIH1cbiAgICB9XG59Il0sIm5hbWVzIjpbIk1hcmtkb3duVmlldyIsIlBsdWdpbiIsIlRGaWxlIiwiTm90aWNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFFQTtBQUNBLE1BQU0sV0FBVyxHQUFHLENBQUMsRUFBcUI7SUFFdEMsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBRTdCLEtBQUksSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQUM7O1FBRzVCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7O1FBRzVCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBQztZQUNiLEtBQUksTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBQztnQkFDMUIsSUFBSSxHQUFHLENBQUMsU0FBUyxLQUFLLGlCQUFpQixFQUFDO29CQUNwQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUE7aUJBQ2Q7YUFDSjtTQUNKO0tBRUo7QUFDTCxDQUFDLENBQUE7QUFFRDtBQUNBLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxRQUFnQixLQUFLLFFBQVEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFNUU7QUFDRCxNQUFNLHFCQUFxQixHQUFFLENBQUMsUUFBZ0IsRUFBRSxLQUFVOzs7Ozs7SUFRdEQsSUFBSSxlQUFlLENBQUM7SUFDcEIsSUFBSSxTQUFTLENBQUM7SUFFZCxJQUFHLFFBQVEsSUFBSSxDQUFDLEVBQUM7UUFDYixlQUFlLEdBQUcsNEJBQTRCLENBQUM7UUFDL0MsU0FBUyxHQUFHLGlCQUFpQixDQUFDO0tBQ2pDO1NBQU0sSUFBRyxRQUFRLElBQUksQ0FBQyxFQUFDO1FBQ3BCLGVBQWUsR0FBRywwQkFBMEIsQ0FBQztRQUM3QyxTQUFTLEdBQUcsc0JBQXNCLENBQUM7S0FDdEM7SUFFRCxJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ2pELElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFMUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUU7UUFDMUMsT0FBTyxFQUFFLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUE7QUFFcEQsQ0FBQyxDQUFBO0FBRUQ7QUFDQSxNQUFNLGlCQUFpQixHQUFHLENBQUMsU0FBb0I7SUFDM0MsT0FBUSxTQUFTLENBQUMsVUFBVSxDQUFDLElBQXFCLENBQUMsSUFBSSxDQUFDO0FBQzVELENBQUMsQ0FBQTtBQUVEO0FBQ0EsTUFBTSxXQUFXLEdBQUcsQ0FBQyxTQUFvQjs7SUFDckMsT0FBTyxNQUFBLE1BQUEsU0FBUyxDQUFDLG1CQUFtQixDQUFDQSxxQkFBWSxDQUFDLDBDQUFFLFVBQVUsMENBQUUsUUFBUSxDQUFBO0FBQzVFLENBQUMsQ0FBQTtBQUVELE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBWTtJQUNoQyxPQUFPLGFBQWEsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQTtBQUNqRCxDQUFDLENBQUE7QUFFRDtBQUNBLE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBWSxFQUFFLEtBQVk7O0lBRTlDLE9BQU8sY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFBO0FBQ25ELENBQUM7O01DckVvQixlQUFnQixTQUFRQyxlQUFNO0lBQW5EOztRQWlCSSwwQkFBcUIsR0FBRyxDQUFDLEVBQU8sRUFBRSxPQUFZO1lBQzFDLE9BQU8sQ0FBQyxJQUFJLENBQUUsQ0FBQyxNQUFXO2dCQUN0QixJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3ZDLENBQUMsQ0FBQTtTQUNMLENBQUE7UUFFRCwyQkFBc0IsR0FBRyxDQUFDLEVBQXFCO1lBQzNDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMvQixDQUFBOztRQVlELGVBQVUsR0FBUSxDQUFDLEVBQXFCLEVBQUUsV0FBbUIsRUFBRSxVQUFpQjs7WUFHNUUsTUFBTSxrQkFBa0IsR0FBRyw4QkFBOEIsQ0FBQTs7WUFFekQsTUFBTSxrQkFBa0IsR0FBRyxtQ0FBbUMsQ0FBQTs7WUFFOUQsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUV0QyxJQUFHLElBQUksS0FBSyxJQUFJO2dCQUFFLE9BQU87O1lBR3pCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDcEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQzs7WUFHcEQsSUFBSSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBMkIsS0FBSyxHQUFHLENBQUMsU0FBUyxLQUFLLGlCQUFpQixDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ3pJLElBQUcsaUJBQWlCLEtBQUssQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQUUsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7O1lBRzdFLElBQUcsT0FBTyxJQUFJLE9BQU8sRUFBQzs7Z0JBR2xCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBQztvQkFDYixLQUFJLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUM7d0JBQzFCLElBQUksR0FBRyxDQUFDLFNBQVMsS0FBSyxpQkFBaUIsRUFBQzs0QkFDcEMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFBO3lCQUNkO3FCQUNKO2lCQUNKOztnQkFHRCxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7Z0JBQ2xCLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFFYixJQUFHLE9BQU8sRUFBQzs7b0JBRVAsUUFBUSxHQUFHLHFCQUFxQixDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUE7b0JBQ3JELEdBQUcsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFBO2lCQUNsRDtxQkFBTSxJQUFHLE9BQU8sRUFBQzs7b0JBRWQsUUFBUSxHQUFHLHFCQUFxQixDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUE7b0JBQ3JELEdBQUcsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFBO2lCQUNsRDs7Z0JBR0QsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Z0JBRzFDLElBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEVBQUM7b0JBQzVCLEdBQUcsQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDO2lCQUN0QjtxQkFBTTs7b0JBRUgsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO29CQUNwQixJQUFHLFVBQVUsRUFBQzt3QkFDVixVQUFVLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQztxQkFDaEM7eUJBQUk7d0JBQ0QsVUFBVSxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDO3FCQUMzRDtvQkFDRCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztvQkFDbEcsSUFBRyxLQUFLLElBQUksSUFBSTt3QkFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQTtpQkFDcEU7O2dCQUdELEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO2dCQUNkLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQztnQkFDNUIsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDOztnQkFHMUIsRUFBRSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLEVBQUMsU0FBUyxFQUFFLGlCQUFpQixFQUFDLENBQUMsQ0FBQzthQUN0RTtTQUNKLENBQUE7O1FBR0QsZ0JBQVcsR0FBUSxDQUFDLEVBQXFCLEVBQUUsVUFBaUI7O1lBRXhELElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM3QixLQUFJLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLElBQUksUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFDO2dCQUM1QixJQUFHQyxjQUFLLEVBQUM7b0JBQ0wsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7aUJBQ3pCO3FCQUFJO29CQUNELElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRUEsY0FBSyxDQUFDLENBQUM7aUJBQ2pDO2FBQ0o7U0FDSixDQUFBOztRQUdELGVBQVUsR0FBRyxDQUFDLFVBQWlCOztZQUUzQixJQUFHLFVBQVUsQ0FBQyxTQUFTLEtBQUssSUFBSSxFQUFDOztnQkFFN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQzthQUNqRTtTQUNKLENBQUE7S0FDSjtJQWpJRyxNQUFNOztRQUVGLElBQUksQ0FBQyxhQUFhLENBQ2QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQ3RELENBQUE7O1FBRUQsSUFBSSxDQUFDLGtCQUFrQixDQUFFLENBQUMsRUFBcUI7WUFDM0MsRUFBRSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7U0FDaEQsQ0FBQyxDQUFBOztRQUVGLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFFLENBQUMsRUFBRTtZQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3hCLENBQUMsQ0FBQTtLQUNMO0lBWUQsUUFBUTtRQUNKLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFFLENBQUMsRUFBRTtZQUN0QyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNyRCxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztZQUM5QyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDbkIsQ0FBQyxDQUFDO1FBQ0gsSUFBSUMsZUFBTSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7S0FDcEQ7Ozs7OyJ9
